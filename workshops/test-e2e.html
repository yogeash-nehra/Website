<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End-to-End System Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .test-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .test-name {
            flex: 1;
            font-weight: 500;
        }
        
        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-pending {
            background: #e0e0e0;
            color: #666;
        }
        
        .status-running {
            background: #ffc107;
            color: #000;
            animation: pulse 1s infinite;
        }
        
        .status-pass {
            background: #4caf50;
            color: white;
        }
        
        .status-fail {
            background: #f44336;
            color: white;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #results {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
            display: none;
        }
        
        #results.show {
            display: block;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #666;
            font-size: 0.9em;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª End-to-End System Test</h1>
        <p class="subtitle">Comprehensive automated testing of your booking system</p>
        
        <!-- Control Buttons -->
        <div style="text-align: center; margin-bottom: 30px;">
            <button class="btn" id="runAllTests" onclick="runAllTests()">
                ðŸš€ Run All Tests
            </button>
            <button class="btn" onclick="runAPITests()">
                ðŸ”Œ Test APIs Only
            </button>
            <button class="btn" onclick="runStripeTest()">
                ðŸ’³ Test Stripe Only
            </button>
            <button class="btn" onclick="location.reload()">
                ðŸ”„ Reset
            </button>
        </div>
        
        <!-- Test Sections -->
        <div id="testSections"></div>
        
        <!-- Summary -->
        <div class="test-section">
            <h2>ðŸ“Š Test Summary</h2>
            <div class="summary">
                <div class="summary-card">
                    <div class="summary-number" id="totalTests">0</div>
                    <div class="summary-label">Total Tests</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" style="color: #4caf50;" id="passedTests">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" style="color: #f44336;" id="failedTests">0</div>
                    <div class="summary-label">Failed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" style="color: #ffc107;" id="successRate">0%</div>
                    <div class="summary-label">Success Rate</div>
                </div>
            </div>
        </div>
        
        <!-- Console Output -->
        <div id="results"></div>
    </div>
    
    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/google-sheets-api.js"></script>
    
    <script>
        const tests = [
            {
                section: 'ðŸ”Œ API Layer',
                items: [
                    { name: 'Config loaded', test: testConfig },
                    { name: 'Apps Script URL accessible', test: testAPIConnection },
                    { name: 'getWorkshops returns data', test: testGetWorkshops },
                    { name: 'getAllEvents returns data', test: testGetAllEvents },
                    { name: 'checkAvailability works', test: testCheckAvailability }
                ]
            },
            {
                section: 'ðŸ’³ Payment Layer',
                items: [
                    { name: 'Stripe.js loaded', test: testStripeLoaded },
                    { name: 'Stripe key valid', test: testStripeKey },
                    { name: 'Stripe initialized', test: testStripeInit }
                ]
            },
            {
                section: 'ðŸ“Š Data Layer',
                items: [
                    { name: 'Workshops exist (expect 19)', test: testWorkshopsCount },
                    { name: 'Events exist (expect >0)', test: testEventsExist },
                    { name: 'Events have available seats', test: testSeatsAvailable }
                ]
            }
        ];
        
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };
        
        function initializeTests() {
            const container = document.getElementById('testSections');
            let totalTests = 0;
            
            tests.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'test-section';
                sectionDiv.innerHTML = `<h2>${section.section}</h2>`;
                
                section.items.forEach((item, index) => {
                    totalTests++;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'test-item';
                    itemDiv.id = `test-${section.section}-${index}`;
                    itemDiv.innerHTML = `
                        <span class="test-name">${item.name}</span>
                        <span class="test-status status-pending" id="status-${section.section}-${index}">Pending</span>
                    `;
                    sectionDiv.appendChild(itemDiv);
                });
                
                container.appendChild(sectionDiv);
            });
            
            testResults.total = totalTests;
            updateSummary();
        }
        
        function updateStatus(section, index, status, message = '') {
            const statusEl = document.getElementById(`status-${section}-${index}`);
            statusEl.className = `test-status status-${status}`;
            statusEl.textContent = status === 'running' ? 'Running...' : 
                                   status === 'pass' ? 'âœ… Pass' : 
                                   status === 'fail' ? 'âŒ Fail' : 'Pending';
            
            if (status === 'pass') testResults.passed++;
            if (status === 'fail') testResults.failed++;
            
            updateSummary();
            
            if (message) {
                logToConsole(`${status === 'pass' ? 'âœ…' : 'âŒ'} ${section} - ${message}`);
            }
        }
        
        function updateSummary() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            const rate = testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0;
            document.getElementById('successRate').textContent = rate + '%';
        }
        
        function logToConsole(message) {
            const results = document.getElementById('results');
            results.classList.add('show');
            results.textContent += message + '\n';
            results.scrollTop = results.scrollHeight;
        }
        
        async function runAllTests() {
            testResults = { total: testResults.total, passed: 0, failed: 0 };
            updateSummary();
            document.getElementById('results').textContent = '';
            logToConsole('ðŸš€ Starting comprehensive system test...\n');
            
            for (const section of tests) {
                logToConsole(`\nðŸ“‹ Testing: ${section.section}`);
                for (let i = 0; i < section.items.length; i++) {
                    const item = section.items[i];
                    updateStatus(section.section, i, 'running');
                    
                    try {
                        const result = await item.test();
                        updateStatus(section.section, i, result.pass ? 'pass' : 'fail', result.message);
                    } catch (error) {
                        updateStatus(section.section, i, 'fail', error.message);
                    }
                    
                    await sleep(500);
                }
            }
            
            logToConsole('\n' + '='.repeat(60));
            logToConsole(`âœ… Tests Passed: ${testResults.passed}/${testResults.total}`);
            logToConsole(`âŒ Tests Failed: ${testResults.failed}/${testResults.total}`);
            logToConsole(`ðŸ“Š Success Rate: ${Math.round((testResults.passed/testResults.total)*100)}%`);
            
            if (testResults.failed === 0) {
                logToConsole('\nðŸŽ‰ ALL TESTS PASSED! Your system is ready!');
            } else {
                logToConsole('\nâš ï¸  Some tests failed. Check details above.');
            }
        }
        
        async function runAPITests() {
            logToConsole('ðŸ”Œ Testing API endpoints...\n');
            // Run only API section
            const apiSection = tests[0];
            for (let i = 0; i < apiSection.items.length; i++) {
                updateStatus(apiSection.section, i, 'running');
                try {
                    const result = await apiSection.items[i].test();
                    updateStatus(apiSection.section, i, result.pass ? 'pass' : 'fail', result.message);
                } catch (error) {
                    updateStatus(apiSection.section, i, 'fail', error.message);
                }
                await sleep(500);
            }
        }
        
        async function runStripeTest() {
            logToConsole('ðŸ’³ Testing Stripe configuration...\n');
            const stripeSection = tests[1];
            for (let i = 0; i < stripeSection.items.length; i++) {
                updateStatus(stripeSection.section, i, 'running');
                try {
                    const result = await stripeSection.items[i].test();
                    updateStatus(stripeSection.section, i, result.pass ? 'pass' : 'fail', result.message);
                } catch (error) {
                    updateStatus(stripeSection.section, i, 'fail', error.message);
                }
                await sleep(500);
            }
        }
        
        // Test Functions
        async function testConfig() {
            if (!CONFIG) return { pass: false, message: 'CONFIG not found' };
            if (!CONFIG.APPS_SCRIPT_URL) return { pass: false, message: 'APPS_SCRIPT_URL missing' };
            if (!CONFIG.STRIPE_PUBLISHABLE_KEY) return { pass: false, message: 'STRIPE_PUBLISHABLE_KEY missing' };
            return { pass: true, message: 'Config loaded successfully' };
        }
        
        async function testAPIConnection() {
            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL + '?action=getWorkshops');
                if (!response.ok) return { pass: false, message: `HTTP ${response.status}` };
                const data = await response.json();
                if (data.error) return { pass: false, message: data.error };
                return { pass: true, message: 'API accessible' };
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testGetWorkshops() {
            try {
                const workshops = await sheetsAPI.getWorkshops();
                if (!workshops || workshops.length === 0) {
                    return { pass: false, message: 'No workshops returned' };
                }
                return { pass: true, message: `${workshops.length} workshops found` };
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testGetAllEvents() {
            try {
                const events = await sheetsAPI.getAllEvents();
                if (!events || events.length === 0) {
                    return { pass: false, message: 'No events returned' };
                }
                return { pass: true, message: `${events.length} events found` };
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testCheckAvailability() {
            try {
                const events = await sheetsAPI.getAllEvents();
                if (events.length === 0) return { pass: false, message: 'No events to test' };
                const result = await sheetsAPI.checkAvailability(events[0].eventId);
                return { pass: true, message: `${result.availableSeats} seats available` };
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testStripeLoaded() {
            if (typeof Stripe === 'undefined') {
                return { pass: false, message: 'Stripe.js not loaded' };
            }
            return { pass: true, message: 'Stripe.js loaded' };
        }
        
        async function testStripeKey() {
            if (!CONFIG.STRIPE_PUBLISHABLE_KEY.startsWith('pk_')) {
                return { pass: false, message: 'Invalid key format' };
            }
            if (CONFIG.STRIPE_PUBLISHABLE_KEY.includes('test')) {
                return { pass: true, message: 'Test key configured' };
            }
            return { pass: true, message: 'Live key configured' };
        }
        
        async function testStripeInit() {
            try {
                const stripe = Stripe(CONFIG.STRIPE_PUBLISHABLE_KEY);
                return { pass: true, message: 'Stripe initialized' };
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testWorkshopsCount() {
            try {
                const workshops = await sheetsAPI.getWorkshops();
                const count = workshops.length;
                if (count === 19) {
                    return { pass: true, message: `Correct: ${count} workshops` };
                } else {
                    return { pass: false, message: `Expected 19, got ${count}` };
                }
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testEventsExist() {
            try {
                const events = await sheetsAPI.getAllEvents();
                if (events.length > 0) {
                    return { pass: true, message: `${events.length} events found` };
                } else {
                    return { pass: false, message: 'No events in system' };
                }
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        async function testSeatsAvailable() {
            try {
                const events = await sheetsAPI.getAllEvents();
                const availableEvents = events.filter(e => e.availableSeats > 0);
                if (availableEvents.length > 0) {
                    return { pass: true, message: `${availableEvents.length} events have seats` };
                } else {
                    return { pass: false, message: 'All events sold out' };
                }
            } catch (error) {
                return { pass: false, message: error.message };
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            initializeTests();
            logToConsole('ðŸ’¡ Ready to test! Click "Run All Tests" to start.\n');
        });
    </script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
</body>
</html>

